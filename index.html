<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>4Fan</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#7a7a7a}
  body{font-family:Arial,system-ui;max-width:980px;margin:16px auto;padding:14px;background:var(--bg);color:var(--text)}
  body.dark{--bg:#061017;--card:#0f1720;--text:#e6eef6;--muted:#94a3b8}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:1.2rem}
  .panel{background:var(--card);padding:12px;border-radius:8px;margin-top:12px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  input,textarea,select,button{font:inherit}
  input,select,textarea{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #cfcfcf;background:transparent;color:inherit}
  textarea{min-height:80px;resize:vertical}
  .row{display:flex;gap:8px}
  .small{width:160px}
  .post{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,.06);margin:10px 0;background:inherit}
  .post-header{display:flex;justify-content:space-between;font-weight:700;margin-bottom:6px}
  .muted{color:var(--muted);font-size:.85rem}
  .reply{margin-left:18px;margin-top:8px;padding:8px;border-radius:6px;background:rgba(0,0,0,0.03)}
  .reply-input{display:flex;gap:8px;margin-top:8px}
  img.post-img{max-width:100%;border-radius:6px;margin-top:6px}
  .btn{background:#0b63d6;color:#fff;padding:8px 10px;border-radius:6px;border:0}
  .btn-danger{background:#d32f2f;color:#fff;padding:8px 10px;border-radius:6px;border:0}
  .smallbtn{padding:6px 8px;border-radius:6px;border:0;background:#eee}
  .blurred{filter:blur(6px)}
  @media(min-width:900px){ .row > *{flex:1} .small{width:220px} }
</style>
</head>
<body>
<header>
  <h1>4Fan</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="darkToggle" class="smallbtn">Dark</button>
    <span id="who" class="muted">Not logged in</span>
  </div>
</header>

<!-- AUTH -->
<div id="authPanel" class="panel">
  <strong>Sign up / Log in — username + password</strong>
  <div style="margin-top:8px">
    <input id="authUser" placeholder="Username (no spaces)"/>
    <input id="authPass" type="password" placeholder="Password"/>
    <div class="row" style="margin-top:6px">
      <button id="signupBtn" class="btn">Sign up</button>
      <button id="loginBtn" class="btn">Log in</button>
      <button id="signoutBtn" class="smallbtn" style="display:none">Sign out</button>
    </div>
    <div class="muted" style="margin-top:8px">We use Firebase Auth (username → fake email). No real email required.</div>
  </div>
</div>

<!-- Forum UI -->
<div id="forum" class="panel" style="display:none">
  <div style="display:flex;gap:8px;align-items:flex-start">
    <select id="category" class="small">
      <option>Gaming</option><option>School News</option><option>Math</option>
      <option>Programming</option><option>Other</option>
    </select>
    <textarea id="message" placeholder="Write a post..."></textarea>
  </div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
    <input id="imageInput" type="file" accept="image/*"/>
    <button id="postBtn" class="btn">Post</button>
  </div>

  <h3 style="margin-top:12px">Posts</h3>
  <div id="posts"></div>
</div>

<!-- Firebase compat SDKs (easier copy/paste) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ====== REPLACE the firebaseConfig below with YOUR project config (Project Settings → SDK setup) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCk8ZiCHs5QoIdtXhOjsDu5q6XTEWLWpaM",
  authDomain: "fan-dea86.firebaseapp.com",
  projectId: "fan-dea86",
  storageBucket: "fan-dea86.firebasestorage.app",
  messagingSenderId: "95861617593",
  appId: "1:95861617593:web:9c601a3f89706feae67c68"
const app = initializeApp(firebaseConfig);
};
/* ================================================================================================ */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ====== banned words (one per line) ====== */
const bannedRaw = `
badword1
badword2
slur1
slur2
`;
const banned = bannedRaw.split('\n').map(s=>s.trim()).filter(Boolean);

/* helpers */
const $ = id => document.getElementById(id);
const escapeHtml = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
function containsBanned(text){
  const t = (text||'').toLowerCase();
  for(const w of banned) if(w && t.includes(w.toLowerCase())) return true;
  return false;
}
function renderMessageHtml(text){
  if(containsBanned(text)) return `<span class="blurred">${escapeHtml(text)}</span>`;
  return `<span>${escapeHtml(text)}</span>`;
}

/* UI toggles */
$('darkToggle').onclick = ()=> document.body.classList.toggle('dark');

/* AUTH (fake-email trick) */
$('signupBtn').onclick = async ()=>{
  const username = $('authUser').value.trim();
  const pass = $('authPass').value;
  if(!username || !pass) return alert('username & password required');
  if(/\s/.test(username)) return alert('no spaces allowed in username');
  const fakeEmail = username + '@jsoft.local';
  try{
    const cred = await auth.createUserWithEmailAndPassword(fakeEmail, pass);
    await cred.user.updateProfile({displayName: username});
    // optional: create a Firestore user doc
    await db.collection('users').doc(cred.user.uid).set({ username, created: firebase.firestore.FieldValue.serverTimestamp() });
    alert('Signed up as ' + username);
  }catch(err){
    if(err.code === 'auth/email-already-in-use') alert('Username taken');
    else alert(err.message);
  }
};

$('loginBtn').onclick = async ()=>{
  const username = $('authUser').value.trim();
  const pass = $('authPass').value;
  if(!username || !pass) return alert('username & password required');
  const fakeEmail = username + '@jsoft.local';
  try{
    await auth.signInWithEmailAndPassword(fakeEmail, pass);
  }catch(err){
    alert(err.message);
  }
};

$('signoutBtn').onclick = ()=> auth.signOut();

/* react to auth changes */
auth.onAuthStateChanged(user=>{
  if(user){
    const username = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
    $('who').textContent = 'Signed in: ' + username;
    $('authPanel').style.display = 'none';
    $('forum').style.display = 'block';
    $('signoutBtn').style.display = 'inline-block';
  } else {
    $('who').textContent = 'Not logged in';
    $('authPanel').style.display = '';
    $('forum').style.display = 'none';
    $('signoutBtn').style.display = 'none';
  }
});

/* Posting */
$('postBtn').onclick = async ()=>{
  const user = auth.currentUser;
  if(!user) return alert('log in first');
  const text = $('message').value.trim();
  if(!text) return alert('message required');
  const category = $('category').value;
  const file = $('imageInput').files[0];
  const author = user.displayName || (user.email && user.email.split('@')[0]);

  if(file){
    if(!file.type.startsWith('image/')) return alert('only images allowed');
    const path = 'images/' + Date.now() + '_' + file.name;
    const ref = storage.ref(path);
    try{
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await savePost(author, user.uid, text, category, url);
    }catch(err){
      console.error(err); alert('upload error: ' + err.message);
    }
  } else {
    await savePost(author, user.uid, text, category, null);
  }

  $('message').value = '';
  $('imageInput').value = '';
};

/* save post to Firestore */
async function savePost(username, uid, message, category, imageUrl){
  await db.collection('posts').add({
    user: username,
    uid,
    message,
    category,
    imageUrl: imageUrl || null,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    replies: []
  });
}

/* realtime render posts */
db.collection('posts').orderBy('timestamp','desc').onSnapshot(snapshot=>{
  const out = $('posts'); out.innerHTML = '';
  snapshot.forEach(doc=>{
    const p = doc.data(); const id = doc.id;
    const postEl = document.createElement('div'); postEl.className='post';
    const timeStr = p.timestamp && p.timestamp.toDate ? p.timestamp.toDate().toLocaleString() : '';
    postEl.innerHTML = `<div class="post-header"><div>${escapeHtml(p.user)} <span class="muted">[${escapeHtml(p.category)}]</span></div><div class="muted">${timeStr}</div></div>
      <div class="post-body">${renderMessageHtml(p.message)}</div>`;

    if(p.imageUrl){
      const img = document.createElement('img'); img.src = p.imageUrl; img.className='post-img'; postEl.appendChild(img);
    }

    // replies
    const replies = p.replies || [];
    for(const r of replies){
      const rdiv = document.createElement('div'); rdiv.className='reply';
      const rtime = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate().toLocaleString() : '';
      rdiv.innerHTML = `<b>${escapeHtml(r.user)}</b> <span class="muted">${rtime}</span><div>${renderMessageHtml(r.message)}</div>`;
      postEl.appendChild(rdiv);
    }

    // reply input
    const replyDiv = document.createElement('div'); replyDiv.className='reply-input';
    const ri = document.createElement('input'); ri.placeholder='Write a reply...';
    const rbtn = document.createElement('button'); rbtn.textContent='Reply'; rbtn.className='smallbtn';
    rbtn.onclick = async ()=>{
      const usr = auth.currentUser;
      if(!usr) return alert('log in to reply');
      const text = ri.value.trim(); if(!text) return;
      await db.collection('posts').doc(id).update({
        replies: firebase.firestore.FieldValue.arrayUnion({
          user: usr.displayName || usr.email.split('@')[0],
          uid: usr.uid,
          message: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
      });
      ri.value = '';
    };
    replyDiv.appendChild(ri); replyDiv.appendChild(rbtn); postEl.appendChild(replyDiv);

    // delete if author
    if(auth.currentUser && auth.currentUser.uid === p.uid){
      const del = document.createElement('button'); del.className='btn-danger'; del.textContent='Delete';
      del.style.marginTop='8px';
      del.onclick = async ()=> {
        if(!confirm('Delete post?')) return;
        await db.collection('posts').doc(id).delete();
      };
      postEl.appendChild(del);
    }

    out.appendChild(postEl);
  });
});

/* quick error output to console for debugging (optional) */
window.addEventListener('error', e=>console.error('JS ERROR', e.message, e.error));
</script>
</body>
</html>
